<!doctype html>
<html lang="vi">
<head>
<meta charset="utf-8" />
<title>Trái tim + sao lấp lánh + mưa câu chúc (Mobile-ready)</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no" />
<style>
  html,body{height:100%;margin:0;background:#000;overflow:hidden;touch-action:none}
</style>
</head>
<body>
<script src="https://cdn.jsdelivr.net/npm/three@0.157.0/build/three.min.js"></script>
<script>
/* ====== MOBILE SETTINGS ====== */
const W = () => window.innerWidth;
const H = () => window.innerHeight;
const isSmall = () => Math.min(W(),H()) < 640;     // điện thoại
const DPR = Math.min(window.devicePixelRatio || 1, isSmall() ? 1.6 : 2);

/* ====== SCENE ====== */
const scene = new THREE.Scene();
const camera = new THREE.PerspectiveCamera(70, W()/H(), 0.1, 6000);
camera.position.set(0, isSmall()? 20 : 30, isSmall()? 190 : 170);

const renderer = new THREE.WebGLRenderer({antialias:true, powerPreference:"high-performance"});
renderer.setPixelRatio(DPR);
renderer.setSize(W(), H());
document.body.appendChild(renderer.domElement);

/* ====== STARFIELD (NỀN) ====== */
function starfield(n, spread){
  const pos=new Float32Array(n*3);
  for (let i=0;i<n;i++){
    pos[3*i]=(Math.random()-0.5)*spread;
    pos[3*i+1]=(Math.random()-0.5)*spread;
    pos[3*i+2]=(Math.random()-0.5)*spread;
  }
  const g=new THREE.BufferGeometry(); g.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const m=new THREE.PointsMaterial({color:0xffffff,size:1,transparent:true,opacity:.9});
  return new THREE.Points(g,m);
}
const stars = starfield(isSmall()? 2200:3500, isSmall()? 1200:1600);
scene.add(stars);

/* ====== HEART (hạt hồng) ====== */
function heart2D(t){ 
  const x=16*Math.pow(Math.sin(t),3);
  const y=13*Math.cos(t)-5*Math.cos(2*t)-2*Math.cos(3*t)-Math.cos(4*t); 
  return {x,y};
}
function createHeartParticles(N=20000, scale=2.5, y=42){
  const pos=new Float32Array(N*3);
  for(let i=0;i<N;i++){
    const t=-Math.PI+Math.random()*Math.PI*2;
    const {x,y:y0}=heart2D(t);
    pos[3*i]=x+(Math.random()-0.5)*2;
    pos[3*i+1]=y0+(Math.random()-0.5)*2;
    pos[3*i+2]=(Math.random()-0.5)*20;
  }
  const g=new THREE.BufferGeometry();
  g.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const m=new THREE.PointsMaterial({
    size:isSmall()?0.5:0.6,color:0xff6bc9,transparent:true,opacity:0.95,
    blending:THREE.AdditiveBlending,depthWrite:false
  });
  const p=new THREE.Points(g,m);
  p.position.y=y; p.scale.set(scale,scale,scale);
  return p;
}
const heart = createHeartParticles(isSmall()? 14000:20000, isSmall()? 2.2:2.5, isSmall()? 38:42);
scene.add(heart);

/* ====== SPRITE CHỮ (cho mưa chữ) ====== */
function makeTextSprite(text, size=80, color="#ffffff"){
  const scale=2, pad=30*scale;
  const c=document.createElement('canvas'), ctx=c.getContext('2d');
  ctx.font=`900 ${size*scale}px Arial`;
  const w=Math.ceil(ctx.measureText(text).width);
  c.width=w+pad*2; c.height=size*scale+pad*2;
  ctx.font=`900 ${size*scale}px Arial`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.lineWidth=8*scale; ctx.strokeStyle='#000';
  ctx.strokeText(text, c.width/2, c.height/2);
  ctx.fillStyle=color; ctx.fillText(text, c.width/2, c.height/2);
  const tex=new THREE.CanvasTexture(c); tex.anisotropy=8;
  const mat=new THREE.SpriteMaterial({map:tex, transparent:true, depthTest:false, depthWrite:false});
  const spr=new THREE.Sprite(mat);
  const k=isSmall()? 0.035:0.04;                      // scale thân thiện mobile
  spr.scale.set((c.width/scale)*k,(c.height/scale)*k,1);
  spr.renderOrder = 999;
  return spr;
}

/* ====== VÒNG SAO (dưới tim) ====== */
function createStarRing(radius, y, count, tiltDeg=-66){
  const pos=new Float32Array(count*3);
  for(let i=0;i<count;i++){
    const a=i/count*Math.PI*2;
    pos[3*i]   = Math.cos(a)*radius;
    pos[3*i+1] = y;
    pos[3*i+2] = Math.sin(a)*radius;
  }
  const g=new THREE.BufferGeometry();
  g.setAttribute('position',new THREE.BufferAttribute(pos,3));
  const m=new THREE.PointsMaterial({
    color:0xffffff, size:isSmall()?1.8:2.2, transparent:true, opacity:0.8
  });
  const ring=new THREE.Points(g,m);
  ring.rotation.x=THREE.MathUtils.degToRad(tiltDeg);
  return ring;
}
const rings=[];
const baseR = isSmall()? [20,32,44] : [22,36,50,64];
baseR.forEach((r,i)=>{
  const ring=createStarRing(r, (isSmall()?-6:-8)-i*12, isSmall()? 100-i*12 : 140-i*15, -66);
  scene.add(ring); rings.push(ring);
});

/* ====== MƯA CÂU CHÚC ====== */
const rainMessages = [
  "Chúc Bảo Ngọc Trung Thu vui vẻ", "Luôn hạnh phúc", "An yên ♥",
  "Yêu thương", "Gia đình đoàn viên", "Mãi bên nhau",
  "Yêu em nhiều lắm", "Mãi bên nhau em nhé", "Vui vẻ mỗi ngày",
  "Cười nhiều hơn nữa", "Mơ những giấc mơ đẹp", "Thành công rực rỡ",
  "Mọi điều như ý", "Sức khoẻ dồi dào", "Hạnh phúc tràn đầy"
];
const raining=[]; let spawnTimer=0;
const MAX_RAIN = isSmall()? 110 : 160;

function spawnRain(){
  if(raining.length>=MAX_RAIN) return;
  const txt=rainMessages[Math.floor(Math.random()*rainMessages.length)];
  const col=["#ffffff","#ff99dd","#ffe08a","#9dffbf"][Math.floor(Math.random()*4)];
  const s=makeTextSprite(txt, isSmall()? 78:90, col);
  s.position.set((Math.random()-0.5)*(isSmall()? 220:240), (isSmall()? 135:150)+Math.random()*40, (Math.random()-0.5)*(isSmall()? 120:150));
  s.userData={vy:(isSmall()?0.35:0.4)+Math.random()*0.45, drift:(Math.random()-0.5)*0.2, life:12+(isSmall()?1:2)};
  scene.add(s); raining.push(s);
}

/* ====== ANIMATE ====== */
let t=0;
function animate(){
  requestAnimationFrame(animate);
  const dt=0.016; t+=dt;

  // tim đập
  heart.rotation.y += 0.0012;
  const beat = 1 + Math.sin(t*2)*0.02;
  heart.scale.set((isSmall()?2.2:2.5)*beat,(isSmall()?2.2:2.5)*beat,(isSmall()?2.2:2.5)*beat);

  // vòng sao lấp lánh + quay
  rings.forEach((r,i)=>{
    r.rotation.y += (i%2?-0.0012:0.0012);
    r.material.opacity = 0.55 + 0.35*Math.sin(t*2 + i); // lấp lánh
  });

  // spawn mưa chữ (thưa hơn trên mobile)
  spawnTimer += dt;
  const spawnEvery = isSmall()? 0.12 : 0.1;
  while(spawnTimer > spawnEvery){ spawnRain(); spawnTimer -= spawnEvery; }

  // update mưa chữ
  for(let i=raining.length-1;i>=0;i--){
    const s=raining[i];
    s.position.y -= s.userData.vy;
    s.position.x += s.userData.drift;
    s.userData.life -= dt;
    if(s.userData.life<=0 || s.position.y < -120){
      scene.remove(s); raining.splice(i,1);
    }
  }

  renderer.render(scene, camera);
}
animate();

/* ====== RESIZE / ORIENTATION ====== */
function onResize(){
  camera.aspect = W()/H();
  camera.updateProjectionMatrix();
  renderer.setPixelRatio(Math.min(window.devicePixelRatio||1, isSmall()?1.6:2));
  renderer.setSize(W(), H());
}
addEventListener('resize', onResize, {passive:true});
addEventListener('orientationchange', ()=>setTimeout(onResize, 250), {passive:true});
</script>
</body>
</html>
